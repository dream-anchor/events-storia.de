# UTF-8
AddDefaultCharset UTF-8

RewriteEngine On
RewriteBase /

# ============================================
# 0. HTTPS + WWW + Trailing Slash — ein 301-Hop
# ============================================

# Nicht-kanonisch OHNE Slash -> https://www. MIT Slash
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} !/$
RewriteCond %{REQUEST_URI} !\.[a-zA-Z0-9]+$
RewriteRule ^(.*)$ https://www.events-storia.de/$1/ [R=301,L]

# Nicht-kanonisch MIT Slash -> https://www.
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteRule ^ https://www.events-storia.de%{REQUEST_URI} [R=301,L]

# Bereits https://www. aber ohne Slash -> Slash hinzufügen
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} !/$
RewriteCond %{REQUEST_URI} !\.[a-zA-Z0-9]+$
RewriteRule ^(.*)$ /$1/ [R=301,L]

# ============================================
# 1. Spezielle Weiterleitungen (Query-String)
# ============================================
RewriteCond %{QUERY_STRING} ^page_id=2881$
RewriteRule ^$ /impressum/? [R=301,L]

# ============================================
# 2. 301 Redirects für alte URLs
# ============================================
RewriteRule ^weihnachtsmenues/?$ / [R=301,L]
RewriteRule ^silvesterparty/?$ / [R=301,L]
RewriteRule ^ristorantestoria-de/?$ / [R=301,L]

# ============================================
# 2b. Multi-Language Slug Redirects
# ============================================
# Prevent DE slugs on EN paths -> correct EN slug
RewriteRule ^en/kontakt/?$ /en/contact/ [R=301,L]
RewriteRule ^en/catering/buffet-fingerfood/?$ /en/catering/finger-food-buffet/ [R=301,L]
RewriteRule ^en/catering/buffet-platten/?$ /en/catering/platters-sharing/ [R=301,L]
RewriteRule ^en/catering/buffet-auflauf/?$ /en/catering/hot-dishes/ [R=301,L]
RewriteRule ^en/catering/pizze-napoletane/?$ /en/catering/pizza-napoletana/ [R=301,L]
RewriteRule ^en/faq-catering-muenchen/?$ /en/catering-faq-munich/ [R=301,L]
RewriteRule ^en/impressum/?$ /en/imprint/ [R=301,L]
RewriteRule ^en/datenschutz/?$ /en/privacy/ [R=301,L]
RewriteRule ^en/cookie-richtlinie/?$ /en/cookie-policy/ [R=301,L]
RewriteRule ^en/agb-catering/?$ /en/catering-terms/ [R=301,L]
RewriteRule ^en/agb-restaurant/?$ /en/restaurant-terms/ [R=301,L]
RewriteRule ^en/agb-gutscheine/?$ /en/voucher-terms/ [R=301,L]
RewriteRule ^en/widerrufsbelehrung/?$ /en/cancellation-policy/ [R=301,L]
RewriteRule ^en/zahlungsinformationen/?$ /en/payment-information/ [R=301,L]
RewriteRule ^en/lebensmittelhinweise/?$ /en/food-information/ [R=301,L]
RewriteRule ^en/haftungsausschluss/?$ /en/disclaimer/ [R=301,L]
RewriteRule ^en/konto/?$ /en/account/ [R=301,L]

# ============================================
# 3. Error Documents
# ============================================
ErrorDocument 404 /index.html

# ============================================
# 4. SPA-Routing & SSG Support
# ============================================
# Statische Dateien direkt ausliefern
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# SSG: Ordner mit index.html direkt ausliefern
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Admin-Bereich: Serve clean HTML without pre-rendered frontend content
RewriteCond %{REQUEST_URI} ^/admin
RewriteRule ^ /admin/index.html [L]

# Frontend: Serve pre-rendered index.html (SPA Fallback)
RewriteRule ^ /index.html [L]

# ============================================
# 5. MIME-Types
# ============================================
<IfModule mod_mime.c>
  AddType application/javascript .js
  AddType text/css .css
  AddType image/webp .webp
  AddType image/svg+xml .svg
  AddType font/woff2 .woff2
  AddType application/xml .xml
  AddType text/plain .txt
</IfModule>

# ============================================
# 6. GZIP-Komprimierung
# ============================================
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json image/svg+xml application/xml
</IfModule>

# ============================================
# 7. Browser-Caching
# ============================================
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# ============================================
# 8. Security Headers
# ============================================
<IfModule mod_headers.c>
  Header set X-Content-Type-Options "nosniff"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
  Header set Permissions-Policy "camera=(), microphone=(), geolocation=(self)"
</IfModule>

# ============================================
# 9. Sitemap XML
# ============================================
<FilesMatch "\.xml$">
  ForceType application/xml
</FilesMatch>

<IfModule mod_headers.c>
  <FilesMatch "sitemap\.xml$">
    Header set Content-Type "application/xml; charset=UTF-8"
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  </FilesMatch>
</IfModule>
AddCharset UTF-8 .xml
